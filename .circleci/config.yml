aliases:
  release-tags: &release-tags
    filters:
      tags:
        ignore:
          - /^.*-SNAPSHOT/
          - latest
          - /^.*-amazon*/
      branches:
        ignore: /.*/

  release-branches: &release-branches
    filters:
      tags:
        ignore: /.*/
      branches:
        only: /^release\/.*/

  only-main-branch: &only-main-branch
    filters:
      tags:
        ignore: /.*/
      branches:
        only: main

  android-executor: &android-executor
    executor:
      name: android/android-docker
      resource-class: large
      tag: 2024.04.1
    environment:
      JVM_OPTS: -Xmx6g
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

  android-machine-emulator: &android-machine-emulator
    executor:
      name: android/android-machine
      resource-class: large
      tag: 2024.04.1

version: 2.1
orbs:
  android: circleci/android@2.5.0
  gcp-cli: circleci/gcp-cli@2.1.0
  revenuecat: revenuecat/sdks-common-config@3.0.0
  codecov: codecov/codecov@3.2.4

parameters:
  action:
    type: enum
    enum: [default, bump, paywall_tester_release, generate_revenuecatui_snapshots]
    default: default

commands:
  install-sdkman:
    description: Install SDKMAN
    steps:
      - run:
          name: Installing SDKMAN
          command: |
            if curl -s "https://get.sdkman.io?rcupdate=false" | bash; then
              echo -e '\nsource "/home/circleci/.sdkman/bin/sdkman-init.sh"' >> $BASH_ENV
              source $BASH_ENV
            else
              echo "Error installing SDKMAN, continuing with default Java" >&2
            fi
      - run:
          name: Setup Java environment
          command: |
            if ! sdk env install; then
              echo "Error installing Java SDK through SDKMAN, continuing with default Java" >&2
            fi

  android-dependencies:
    steps:
      - android/restore-gradle-cache
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies
      - android/save-gradle-cache

  prepare-signing-key:
    steps:
      - run:
          name: Prepare GPG keystore file
          command: |
            export GPG_KEY_FILE=`mktemp`
            echo "export GPG_KEY=$GPG_KEY_FILE" >> $BASH_ENV
      - run:
          name: Base64 decode gpg keystore to file
          command: echo $SIGNING_GPG_BASE64 | base64 --decode > $GPG_KEY
      - run:
          name: Import GPG keys
          command: gpg --batch --import $GPG_KEY
      - run:
          name: Fixing GPG compatibility
          command: |
            echo $GPG_SIGNING_KEY_PW_NEW | gpg --batch --pinentry-mode=loopback --passphrase-fd 0 \
            --export-secret-keys > /home/circleci/.gnupg/secring.gpg

  run-firebase-tests:
    parameters:
      app_apk_path:
        type: string
      test_apk_path:
        type: string
    steps:
      - gcp-cli/initialize:
          gcloud-service-key: GCLOUD_SERVICE_KEY
          google-compute-zone: GOOGLE_COMPUTE_ZONE
          google-project-id: GOOGLE_PROJECT_ID
      - run:
          name: Test with Firebase Test Lab
          command: >
            gcloud firebase test android run --type instrumentation \
              --app <<parameters.app_apk_path>> \
              --test <<parameters.test_apk_path>> \
              --device model=panther,version=33,locale=en,orientation=portrait \
              --timeout 2m \
              --results-bucket cloud-test-${GOOGLE_PROJECT_ID}
      - run:
          name: Copy test results data
          command: |
            mkdir -p ~/gsutil/
            gsutil -m cp -r -U `gsutil ls gs://cloud-test-$GOOGLE_PROJECT_ID | tail -1` ~/gsutil/ | true
          when: always
      - store_artifacts:
          path: ~/gsutil/
      - store_test_results:
          path: ~/gsutil/

jobs:

  assemble-magic-weather-compose-sample-app:
    <<: *android-executor
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/accept-licenses
      - android-dependencies
      - android/restore-build-cache
      - run:
          name: Build sample app
          command: bundle exec fastlane android build_magic_weather_compose
      - android/save-build-cache

  assemble-custom-entitlement-computation-sample-app:
    <<: *android-executor
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/accept-licenses
      - android-dependencies
      - android/restore-build-cache
      - run:
          name: Build sample app
          command: bundle exec fastlane android build_custom_entitlement_computation_sample
      - android/save-build-cache

  test:
    <<: *android-executor
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - install-sdkman
      - android/accept-licenses
      - android-dependencies
      - android/restore-build-cache
      - run:
          name: Verify purchases-android target SDK compatibility (currently 33)
          command: ./gradlew :test-apps:testpurchasesandroidcompatibility:assembleDebug
      - run:
          name: Verify purchases-ui target SDK compatibility (currently 34)
          command: ./gradlew :test-apps:testpurchasesuiandroidcompatibility:assembleDebug
      - run:
          name: Run Tests
          command: ./gradlew lint test
      - run:
          name: Consolidate artifacts
          command: |
              mkdir -p build/test-results/
              find . -type f -regex ".*/build/test-results/.*xml" -exec cp --parents {} build/test-results/ \;
      - run:
          name: Kover HTML
          command: ./gradlew purchases:koverHtmlReportDefaultsRelease
      - run:
          name: Kover XML
          command: ./gradlew purchases:koverXmlReportDefaultsRelease
      - codecov/upload:
          file: purchases/build/reports/kover/reportDefaultsRelease.xml
      - android/save-build-cache
      - store_artifacts:
          path: build/reports
      - run:
          name: Save test results
          command: |
            mkdir -p build/test-results
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} build/test-results \;
          when: always
      - store_test_results:
          path: build/test-results

  detekt:
    <<: *android-executor
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - install-sdkman
      - android/restore-gradle-cache
      - run:
          name: Detekt
          command: ./gradlew detektAll
      - android/save-gradle-cache

  docs-deploy:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: Dokka
          command: ./gradlew dokkaHtmlMultiModule
      - android/save-gradle-cache
      - android/save-build-cache
      - run:
          name: Install pip
          command: sudo apt update && sudo apt install python3-pip
      - run:
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Deploy to S3
          command: aws s3 sync ~/project/docs/8.7.0 s3://purchases-docs/android/8.7.0 --delete
      - run:
          name: Update index.html
          command: aws s3 cp ~/project/docs/index.html s3://purchases-docs/android/index.html
      - run:
          name: Invalidate CloudFront caches
          command: aws cloudfront create-invalidation --distribution-id EPTW7F3CB566V --paths "/*"

  deploy:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/setup-git-credentials
      - revenuecat/trust-github-key
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - prepare-signing-key
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: Deployment
          command: |
            bundle exec fastlane android deploy
      - android/save-gradle-cache
      - android/save-build-cache

  prepare-next-version:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - revenuecat/setup-git-credentials
      - revenuecat/trust-github-key
      - run:
          name: Prepare next version
          command: bundle exec fastlane prepare_next_version

  deploy-snapshot:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-gradle-cache:
          cache-prefix: v1a
      - android/restore-build-cache:
          cache-prefix: v1a
      - prepare-signing-key
      - run:
          name: Deployment
          command: |
            bundle exec fastlane android deploy_snapshot
      - android/save-gradle-cache:
          cache-prefix: v1a
      - android/save-build-cache:
          cache-prefix: v1a

  assemble-purchase-tester:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - android/accept-licenses
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: Prepare Keystore
          working_directory: examples/purchase-tester
          command: echo $RELEASE_KEYSTORE | base64 -d > keystore
      - run:
          name: Assemble
          command: |
            ./gradlew -p examples/purchase-tester assemble \
            -PreleaseKeyAlias=$RELEASE_KEY_ALIAS \
            -PreleaseKeystorePassword=$RELEASE_KEYSTORE_PASSWORD \
            -PreleaseKeyPassword=$RELEASE_KEY_PASSWORD
      - store_artifacts:
          path: examples/purchase-tester/build/outputs/apk/release/purchase-tester-release.apk
      - store_artifacts:
          path: examples/purchase-tester/build/outputs/apk/debug/purchase-tester-debug.apk
      - android/save-gradle-cache
      - android/save-build-cache

  publish-purchase-tester-release:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/accept-licenses
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: Prepare Keystore
          working_directory: examples/purchase-tester
          command: echo $PURCHASE_TESTER_RELEASE_KEYSTORE | base64 -d > keystore
      - run:
          name: Create app bundle
          command: |
            bundle exec fastlane android build_purchase_tester_bundle
      - store_artifacts:
          path: examples/purchase-tester/build/outputs/bundle/release/purchase-tester-release.aab
      - android/save-gradle-cache
      - android/save-build-cache
      - run:
            name: Publish aab
            command: |
              bundle exec fastlane android publish_purchase_tester aab_path:'examples/purchase-tester/build/outputs/bundle/release/purchase-tester-release.aab'

  publish-paywall-tester-release:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/accept-licenses
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: Prepare Keystore
          working_directory: examples/paywall-tester
          command: echo $PAYWALL_TESTER_RELEASE_KEYSTORE | base64 -d > keystore
      - run:
          name: Replace API_KEY
          working_directory: examples/paywall-tester/src/main/java/com/revenuecat/paywallstester/
          command: |
            sed -i s/\"API_KEY\"/\"$PAYWALL_TESTER_API_KEY\"/ Constants.kt
      - run:
          name: Create app bundle
          command: |
            bundle exec fastlane android build_paywall_tester_bundle
      - store_artifacts:
          path: examples/paywall-tester/build/outputs/bundle/release/paywall-tester-release.aab
      - android/save-gradle-cache
      - android/save-build-cache
      - run:
            name: Publish aab
            command: |
              bundle exec fastlane android publish_paywall_tester aab_path:'examples/paywall-tester/build/outputs/bundle/release/paywall-tester-release.aab'

  integration-tests-build:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - run:
          name: Replace API_KEY
          working_directory: integration-tests/src/androidTest/java/com/revenuecat/purchases/integrationtests/
          command: |
            sed -i s/REVENUECAT_API_KEY/$API_KEY/ IntegrationTest.kt
      - android/restore-build-cache
      - run:
          name: Prepare Keystore
          working_directory: integration-tests
          command: echo $RELEASE_KEYSTORE | base64 -d > keystore
      - run:
          name: Assemble Release APK
          command: |
            ./gradlew -p integration-tests assembleRelease \
            -PreleaseKeyAlias=$RELEASE_KEY_ALIAS \
            -PreleaseKeystorePassword=$RELEASE_KEYSTORE_PASSWORD \
            -PreleaseKeyPassword=$RELEASE_KEY_PASSWORD
      - run:
          name: Assemble AndroidTest APK
          command: |
            ./gradlew -p integration-tests assembleAndroidTest -PtestBuildType=release \
            -PreleaseKeyAlias=$RELEASE_KEY_ALIAS \
            -PreleaseKeystorePassword=$RELEASE_KEYSTORE_PASSWORD \
            -PreleaseKeyPassword=$RELEASE_KEY_PASSWORD
      - android/save-build-cache
      - persist_to_workspace:
          root: .
          paths:
            - integration-tests/build/outputs/apk/release/integration-tests-release.apk
            - integration-tests/build/outputs/apk/androidTest/release/integration-tests-release-androidTest.apk

  purchases-integration-tests-build:
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-build-cache
      - run:
          name: Create purchases integration tests apks
          command: |
            bundle exec fastlane android build_default_purchases_integration_tests
      - android/save-build-cache
      - persist_to_workspace:
          root: .
          paths:
            - purchases/test_artifacts/integrationTest-app.apk
            - purchases/test_artifacts/integrationTest-test.apk

  run-firebase-tests-purchases-integration-test:
    description: "Run purchases module integration tests for Android in Firebase. Variant integrationTest"
    executor: gcp-cli/google
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run-firebase-tests:
          app_apk_path: purchases/test_artifacts/integrationTest-app.apk
          test_apk_path: purchases/test_artifacts/integrationTest-test.apk

  run-firebase-tests-purchases-load-shedder-integration-test:
    description: "Run purchases module integration tests for Android in Firebase using the load shedder servers"
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - gcp-cli/install
      - gcp-cli/initialize:
          gcloud-service-key: GCLOUD_SERVICE_KEY
          google-compute-zone: GOOGLE_COMPUTE_ZONE
          google-project-id: GOOGLE_PROJECT_ID
      - android/restore-build-cache
      - run:
          name: Build and run load shedder integration tests
          command: |
            bundle exec fastlane android run_load_shedder_purchases_integration_tests
      - android/save-build-cache
      - store_artifacts:
          path: ~/gsutil/
      - store_test_results:
          path: ~/gsutil/

  run-firebase-tests-purchases-custom-entitlement-computation-integration-test:
    description: "Run purchases module integration tests in the custom entitlement computation flavor for Android in Firebase."
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - gcp-cli/install
      - gcp-cli/initialize:
          gcloud-service-key: GCLOUD_SERVICE_KEY
          google-compute-zone: GOOGLE_COMPUTE_ZONE
          google-project-id: GOOGLE_PROJECT_ID
      - android/restore-build-cache
      - run:
          name: Build and run custom entitlement computation integration tests
          command: |
            bundle exec fastlane android run_custom_entitlement_computation_integration_tests
      - android/save-build-cache
      - store_artifacts:
          path: ~/gsutil/
      - store_test_results:
          path: ~/gsutil/

  verify_debug_view_snapshot_tests:
    description: "Verify debug view snapshot tests"
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-build-cache
      - run:
          name: Build and run debugview snapshot tests
          command: |
            bundle exec fastlane android verify_debug_view_snapshot_tests
      - android/save-build-cache

  run-firebase-tests:
    description: "Run integration tests for Android in Firebase. Variant latestDependencies"
    executor: gcp-cli/google
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run-firebase-tests:
          app_apk_path: integration-tests/build/outputs/apk/release/integration-tests-release.apk
          test_apk_path: integration-tests/build/outputs/apk/androidTest/release/integration-tests-release-androidTest.apk

  run-backend-integration-tests:
    description: "Run backend integration tests. All variants"
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-build-cache
      - run:
          name: Run backend integration tests
          command: |
            bundle exec fastlane android run_backend_integration_tests
      - android/save-build-cache
      - run:
          name: Save test results
          command: |
            mkdir -p build/test-results
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} build/test-results \;
          when: always
      - store_test_results:
          path: build/test-results

  verify-revenuecatui-snapshots:
    description: "Verify RevenueCatUI snapshots"
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-build-cache
      - run:
          name: Build and run RevenueCat UI snapshot tests
          command: |
            bundle exec fastlane android verify_revenuecatui_snapshots
      - android/save-build-cache

  record-revenuecatui-snapshots:
    description: "Record new RevenueCatUI snapshots"
    <<: *android-executor
    steps:
      - checkout
      - install-sdkman
      - revenuecat/install-gem-unix-dependencies:
          cache-version: v1
      - android/restore-build-cache
      - revenuecat/setup-git-credentials
      - run:
          name: Records new RevenueCat UI snapshots to become the new golden
          command: |
            bundle exec fastlane android record_revenuecatui_snapshots
      - run:
          command: |
            bundle exec fastlane android create_snapshots_repo_pr
      - android/save-build-cache

  run-revenuecatui-ui-tests:
    description: "Run RevenueCatUI UI tests for Android in CircleCI"
    <<: *android-machine-emulator
    steps:
      - checkout
      - install-sdkman
      - android/create-avd:
          avd-name: test-revenuecat-ui
          system-image: system-images;android-32;google_apis;x86_64
          install: true
      - android/start-emulator:
          avd-name: test-revenuecat-ui
          post-emulator-launch-assemble-command: ./gradlew ui:revenuecatui:assembleDebugAndroidTest
      - run:
          command: |
            ./gradlew ui:revenuecatui:connectedDebugAndroidTest

workflows:
  version: 2
  danger:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - revenuecat/danger

  snapshot-deploy-sample-app-tests:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - deploy-snapshot: *only-main-branch
      - assemble-magic-weather-compose-sample-app:
          <<: *only-main-branch
          requires:
            - deploy-snapshot
      - assemble-custom-entitlement-computation-sample-app:
          <<: *only-main-branch
          requires:
            - deploy-snapshot

  build-test-deploy:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - test
      - detekt
      - assemble-purchase-tester
      - run-backend-integration-tests
      - verify-revenuecatui-snapshots
      - run-revenuecatui-ui-tests
      - verify_debug_view_snapshot_tests: *release-branches
      - integration-tests-build: *release-branches
      - purchases-integration-tests-build: *release-branches
      - run-firebase-tests-purchases-custom-entitlement-computation-integration-test:
          <<: *release-branches
      - run-firebase-tests-purchases-integration-test:
          requires:
            - purchases-integration-tests-build
      - run-firebase-tests-purchases-load-shedder-integration-test:
          <<: *release-branches
          context:
            - slack-secrets
      - run-firebase-tests:
          requires:
            - integration-tests-build
      - hold:
          type: approval
          requires:
            - test
            - assemble-purchase-tester
            - run-backend-integration-tests
            - run-revenuecatui-ui-tests
            - run-firebase-tests
            - run-firebase-tests-purchases-integration-test
            - run-firebase-tests-purchases-load-shedder-integration-test
            - run-firebase-tests-purchases-custom-entitlement-computation-integration-test
          <<: *release-branches
      - revenuecat/tag-current-branch:
          requires:
            - hold
          <<: *release-branches
      - deploy: *release-tags
      - docs-deploy: *release-tags
      - publish-purchase-tester-release:
          requires:
            - deploy
            - docs-deploy
          <<: *release-tags
      - publish-paywall-tester-release:
          requires:
              - deploy
              - docs-deploy
          <<: *release-tags

  snapshot-bump:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - prepare-next-version: *only-main-branch

  daily-load-shedder-integration-tests:
    when:
      and:
        - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        - equal: [ "load-shedder-integration-tests", << pipeline.schedule.name >> ]
    jobs:
      - run-firebase-tests-purchases-load-shedder-integration-test:
          context:
            - slack-secrets

  weekly-run-workflow:
    when:
      and:
        - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        - equal: [ "release-train", << pipeline.schedule.name >> ]
    jobs:
      - revenuecat/automatic-bump

  manual-trigger-bump:
    when:
      equal: [ bump, << pipeline.parameters.action >> ]
    jobs:
      - revenuecat/automatic-bump

  manual-paywall-tester-release:
    when:
      equal: [ paywall_tester_release, << pipeline.parameters.action >> ]
    jobs:
        - publish-paywall-tester-release

  record-revenuecatui-snapshots:
    when:
      equal: [ generate_revenuecatui_snapshots, << pipeline.parameters.action >> ]
    jobs:
      - record-revenuecatui-snapshots
